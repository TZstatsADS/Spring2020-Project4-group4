Rating_by_u[tmp]
Rating_by_u[i]
Rating_by_u[i]=Rating_by_u[tmp]
for (i in Movie_NOTrated_by_u){
tmp=distance_movie[i,Movie_rated_by_u]%>%which.min%>%names
Rating_by_u[i]=Rating_by_u[tmp]
}
R[u,]
R[u,]==Rating_by_u
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u=R[u,]
for (i in Movie_NOTrated_by_u){
tmp=distance_movie[i,Movie_rated_by_u]%>%which.min%>%names
Rating_by_u[i]=Rating_by_u[tmp]
}
R[u,]=Rating_by_u
}
rating_knn=R
R<-t(P)%*%Q  #
rating_knn%>%dim
R%>%dim
R==rating_knn
(R==rating_knn)%>%sum
(R!=rating_knn)%>%sum
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u=R[u,]
for (i in Movie_NOTrated_by_u){
tmp=distance_movie[i,Movie_rated_by_u]%>%which.min%>%names
Rating_by_u[i]=Rating_by_u[tmp]
}
R[u,]=Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
{
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.min%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.min%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$q) %*% resultr12$p
Rating%>%dim
Rating=t(Rating)
RMSE <- function(rating, est_rating){
sqr_err <- function(obs){
sqr_error <- (obs[3] - est_rating[as.character(obs[1]), as.character(obs[2])])^2
return(sqr_error)
}
return(sqrt(mean(apply(rating, 1, sqr_err))))
}
RMSE(data_test2,Rating)
RMSE(data_test2,KNN_Rating)
similarity.matrix<-cosine(resultr12$q)
library(coop)
library(plyr)
similarity.matrix<-cosine(resultr12$q)
View(similarity.matrix)
Q<-result$q #movie
distance_movie<-dist.cosine(t(Q))%>%as.matrix()+1.2*diag(I)
View(distance_movie)
View(distance_movie)
Rating<-t(resultr12$q)%*%(resultr12$p)
Rating%>%dim
Rating<-t(resultr12$p)%*%(resultr12$q)
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$p)%*%(resultr12$q)
tibble(rating=c("without knn","with knn"))
tibble(rating=c("w/o knn","w/  knn"))
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,KNN_Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,KNN_Rating),RMSE(data_test2,KNN_Rating)))
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.max%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$p)%*%(resultr12$q)
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()#+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.max%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$p)%*%(resultr12$q)
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()#+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.max%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$p)%*%(resultr12$q)
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
#"We use prediction by one nearest neighbor using similarity and refer to this method as ”SVD KNN”." ->K=1
KNN.post<-function(result){
Q<-result$q #movie
P<-result$p #user
R<-t(P)%*%Q  #
User_all<-colnames(P)
Movie_all<-colnames(Q)
U<-User_all%>%length()
I<-Movie_all%>%length()
distance_movie<-dist.cosine(t(Q))%>%as.matrix()#+1.2*diag(I)
rownames(distance_movie)<-Movie_all
colnames(distance_movie)<-Movie_all
for (u in 1:U){
Movie_rated_by_u<-train[train$userId == u,]$movieId%>%unique%>%as.character()
Movie_NOTrated_by_u<-Movie_all[!Movie_all%in%Movie_rated_by_u]
Rating_by_u<-R[u,]
for (i in Movie_NOTrated_by_u){
tmp<-distance_movie[i,Movie_rated_by_u]%>%which.max%>%names
Rating_by_u[i]<-Rating_by_u[tmp]
}
R[u,]<-Rating_by_u
}
return(rating_knn=R)
}
KNN_Rating<-KNN.post(resultr12)
Rating<-t(resultr12$p)%*%(resultr12$q)
RMSE <- function(rating, est_rating){
sqr_err <- function(obs){
sqr_error <- (obs[3] - est_rating[as.character(obs[1]), as.character(obs[2])])^2
return(sqr_error)
}
return(sqrt(mean(apply(rating, 1, sqr_err))))
}
tibble(rating=c("w/o knn","w/  knn"),
train=c(RMSE(data_train2,Rating),RMSE(data_train2,KNN_Rating)),
test=c(RMSE(data_test2,Rating),RMSE(data_test2,KNN_Rating)))
library(tidyverse)
library(caret)
library(parallel)
RMSE <- function(rating, est_rating){
sqr_err <- function(obs){
sqr_error <- (obs[3] - est_rating[as.character(obs[1]), as.character(obs[2])])^2
return(sqr_error)
}
return(sqrt(mean(apply(rating, 1, sqr_err))))
}
minFunc <- function(rating, matSolv, lambda){
solve(matSolv %*% t(matSolv) + lambda * diag(f)) %*% matSolv %*% rating
}
# The Function used to Find the
findSolve <- function(id, solveBy, train, lambda){
id <- as.integer(id)
# Fix Movies, solve User
if(solveBy=="Movies"){
movId <- train[train$userId==id, ]$movieId
movSolv <- Movies[, as.character(movId)]
rating <- train[train$userId==id, ]$rating
minFunc(rating = rating, matSolv = movSolv, lambda = lambda)
}
# Fix User, solve Movie
else if(solveBy=="Users"){
userId <- train[train$movieId==id, ]$userId
userSolv <- Users[, as.character(userId)]
rating <- train[train$movieId==id, ]$rating
minFunc(rating = rating, matSolv = userSolv, lambda = lambda)
}
else return("Please let matSolv be in right way")
}
data <- read.csv("../data/ml-latest-small/ratings.csv")
set.seed(1)
# train-test split (.8/.2)
train_ind <- createDataPartition(data$userId, p=.8, list=F)
train <- data[train_ind, ]
test <- data[-train_ind, ]
ALS <- function(data, train, test, f, maxIters, lambda=5){
# Factorized the Movies and User matrices
UserId <- unique(data$userId)
U <- length(UserId)
MovieId <- unique(data$movieId)
M <- length(MovieId)
avgRatingByUser <- data %>%
group_by(userId) %>%
summarise(avgRating = mean(rating))
avgRatingByMovie <- data %>%
group_by(movieId) %>%
summarise(avgRating = mean(rating))
Users <- matrix(c(avgRatingByUser$avgRating, runif((f-1)*U, -1, 1)), nrow=f, byrow = T)
colnames(Users) <- UserId
Movies <- matrix(c(avgRatingByMovie$avgRating, rnorm((f-1)*M, -1, 1)), nrow=f, byrow = T)
colnames(Movies) <- MovieId
clusterExport(cl, "minFunc", envir = environment())
clusterExport(cl, "f", envir = environment())
clusterExport(cl, "UserId", envir = environment())
clusterExport(cl, "MovieId", envir = environment())
trainRMSE <- rep(NA, maxIters%/%3)
testRMSE <- rep(NA, maxIters%/%3)
iter <- 1
while(iter <= maxIters){
st <- Sys.time()
# Fix Movie, solve User
clusterExport(cl, "Movies", envir = environment())
clusterExport(cl, "Users", envir = environment())
Users <- parSapply(cl, as.character(UserId), findSolve, solveBy="Movies", train = train, lambda = lambda, USE.NAMES = T)
# Fix User, solve Movie
clusterExport(cl, "Movies", envir = environment())
clusterExport(cl, "Users", envir = environment())
Movies <- parSapply(cl, as.character(MovieId), findSolve, solveBy="Users", train = train, lambda = lambda, USE.NAMES = T)
# cat("Iter:", iter,  "\t Time spent:", round(Sys.time()-st, 3), "s\n")
# if(iter%%3==1){
#   est_rating <- t(Users) %*% Movies
#
#   trainRMSE[iter%/%3+1] <- RMSE(train, est_rating)
#   testRMSE[iter%/%3+1] <- RMSE(test, est_rating)
# }
cat(".")
if(iter==maxIters) cat("\n")
iter <- iter + 1
}
# RMSE
est_rating <- t(Users) %*% Movies
trainRMSE <- RMSE(train, est_rating)
testRMSE <- RMSE(test, est_rating)
return(list("User" = Users,
"Movie" = Movies,
"Rating" = est_rating,
"TrainRMSE" = trainRMSE,
"TestRMSE" = testRMSE))
}
source("../lib/cross_validation.R")
source("../lib/P3.R")
fs <- c(5, 10, 15)
lambdas_als <- c(1, 5,10)
lambdas_P <- c(1, 5, 10)
sigmas <- c(1,2,3)
cv.df <- expand.grid("fs"=fs,
"lambdas_als"=lambdas_als,
"lambdas_p"=lambdas_P,
"sigmas" =sigmas)
ALS_KRR <- function(data, train, test, f, maxIters, lambda_als, lambda_p, sigma){
# data=dat_train
# train=train.data
# test=test.data
# f=f
# maxIters=maxIter
# lambda=lambdas_als
# lambda_p=lambdas_p
# sigma=sigmas
result_ALS <- ALS(data, train, test, f, maxIters, lambda_als)
KRR.Post(result_ALS=result_ALS,lambda=lambda_p, sigma=sigma, data, train, test)
}
cl <- makeCluster(8)
cl <- makeCluster(8)
load( file="../output/cvtmp.RData")
for (i in 47:dim(x)[1]){
tmp=cv.functionYQ(dat_train = data,K=5,f=x[i,]$fs,maxIter =15,lambdas_als = x[i,]$lambdas_als,lambdas_p = x[i,]$lambdas_p,sigmas =  x[i,]$sigmas)
x[i,"train_mean"]=tmp$mean_train_rmse
x[i,"test_mean"]=tmp$mean_test_rmse
# x[i,"train_sd"]=tmp$sd_train_rmse
# x[i,"test_sd"]=tmp$sd_test_rmse
rm(tmp)
}
library(tidyverse)
library(caret)
library(parallel)
data <- read.csv("../data/ml-latest-small/ratings.csv")
set.seed(1)
# train-test split (.8/.2)
train_ind <- createDataPartition(data$userId, p=.8, list=F)
train <- data[train_ind, ]
test <- data[-train_ind, ]
RMSE <- function(rating, est_rating){
sqr_err <- function(obs){
sqr_error <- (obs[3] - est_rating[as.character(obs[1]), as.character(obs[2])])^2
return(sqr_error)
}
return(sqrt(mean(apply(rating, 1, sqr_err))))
}
minFunc <- function(rating, matSolv, lambda){
solve(matSolv %*% t(matSolv) + lambda * diag(f)) %*% matSolv %*% rating
}
# The Function used to Find the
findSolve <- function(id, solveBy, train, lambda){
id <- as.integer(id)
# Fix Movies, solve User
if(solveBy=="Movies"){
movId <- train[train$userId==id, ]$movieId
movSolv <- Movies[, as.character(movId)]
rating <- train[train$userId==id, ]$rating
minFunc(rating = rating, matSolv = movSolv, lambda = lambda)
}
# Fix User, solve Movie
else if(solveBy=="Users"){
userId <- train[train$movieId==id, ]$userId
userSolv <- Users[, as.character(userId)]
rating <- train[train$movieId==id, ]$rating
minFunc(rating = rating, matSolv = userSolv, lambda = lambda)
}
else return("Please let matSolv be in right way")
}
ALS <- function(data, train, test, f, maxIters, lambda=5){
# Factorized the Movies and User matrices
UserId <- unique(data$userId)
U <- length(UserId)
MovieId <- unique(data$movieId)
M <- length(MovieId)
avgRatingByUser <- data %>%
group_by(userId) %>%
summarise(avgRating = mean(rating))
avgRatingByMovie <- data %>%
group_by(movieId) %>%
summarise(avgRating = mean(rating))
Users <- matrix(c(avgRatingByUser$avgRating, runif((f-1)*U, -1, 1)), nrow=f, byrow = T)
colnames(Users) <- UserId
Movies <- matrix(c(avgRatingByMovie$avgRating, rnorm((f-1)*M, -1, 1)), nrow=f, byrow = T)
colnames(Movies) <- MovieId
clusterExport(cl, "minFunc", envir = environment())
clusterExport(cl, "f", envir = environment())
clusterExport(cl, "UserId", envir = environment())
clusterExport(cl, "MovieId", envir = environment())
trainRMSE <- rep(NA, maxIters%/%3)
testRMSE <- rep(NA, maxIters%/%3)
iter <- 1
while(iter <= maxIters){
st <- Sys.time()
# Fix Movie, solve User
clusterExport(cl, "Movies", envir = environment())
clusterExport(cl, "Users", envir = environment())
Users <- parSapply(cl, as.character(UserId), findSolve, solveBy="Movies", train = train, lambda = lambda, USE.NAMES = T)
# Fix User, solve Movie
clusterExport(cl, "Movies", envir = environment())
clusterExport(cl, "Users", envir = environment())
Movies <- parSapply(cl, as.character(MovieId), findSolve, solveBy="Users", train = train, lambda = lambda, USE.NAMES = T)
# cat("Iter:", iter,  "\t Time spent:", round(Sys.time()-st, 3), "s\n")
# if(iter%%3==1){
#   est_rating <- t(Users) %*% Movies
#
#   trainRMSE[iter%/%3+1] <- RMSE(train, est_rating)
#   testRMSE[iter%/%3+1] <- RMSE(test, est_rating)
# }
cat(".")
if(iter==maxIters) cat("\n")
iter <- iter + 1
}
# RMSE
est_rating <- t(Users) %*% Movies
trainRMSE <- RMSE(train, est_rating)
testRMSE <- RMSE(test, est_rating)
return(list("User" = Users,
"Movie" = Movies,
"Rating" = est_rating,
"TrainRMSE" = trainRMSE,
"TestRMSE" = testRMSE))
}
# # set the number of cores to use
# cl <- makeCluster(8)
# result <- ALS(data, train, test, f = 10, maxIters = 15, lambda = 1)
# stopCluster(cl)
source("../lib/cross_validation.R")
source("../lib/P3.R")
fs <- c(5, 10, 15)
lambdas_als <- c(1, 5,10)
lambdas_P <- c(1, 5, 10)
sigmas <- c(1,2,3)
cv.df <- expand.grid("fs"=fs,
"lambdas_als"=lambdas_als,
"lambdas_p"=lambdas_P,
"sigmas" =sigmas)
ALS_KRR <- function(data, train, test, f, maxIters, lambda_als, lambda_p, sigma){
# data=dat_train
# train=train.data
# test=test.data
# f=f
# maxIters=maxIter
# lambda=lambdas_als
# lambda_p=lambdas_p
# sigma=sigmas
result_ALS <- ALS(data, train, test, f, maxIters, lambda_als)
KRR.Post(result_ALS=result_ALS,lambda=lambda_p, sigma=sigma, data, train, test)
}
cl <- makeCluster(8)
load( file="../output/cvtmp.RData")
# x=cv.df%>%as_tibble()%>%mutate(train_mean=NA,test_mean=NA,train_sd=NA,test_sd=NA)#%>%head(2)
# x=cv.df%>%as_tibble()%>%mutate(train_mean=NA,test_mean=NA)
for (i in 47:dim(x)[1]){
tmp=cv.functionYQ(dat_train = data,K=5,f=x[i,]$fs,maxIter =15,lambdas_als = x[i,]$lambdas_als,lambdas_p = x[i,]$lambdas_p,sigmas =  x[i,]$sigmas)
x[i,"train_mean"]=tmp$mean_train_rmse
x[i,"test_mean"]=tmp$mean_test_rmse
# x[i,"train_sd"]=tmp$sd_train_rmse
# x[i,"test_sd"]=tmp$sd_test_rmse
rm(tmp)
}
save(x, file="../output/cvtmp.RData")
x[81,]
source("../lib/ALSwithP3.R")
